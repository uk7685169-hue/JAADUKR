# Waifu Collection Bot

## Overview

A Telegram bot that implements an anime character collection and gacha game system. Users can collect waifus (anime characters), manage their collections (harems), earn virtual currencies (berries, gems, crimson), and participate in guess games. The system includes two separate bots: the main collection bot and a specialized guess game bot.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Bot Architecture

**Problem**: Need to run two separate Telegram bots with different purposes
**Solution**: Dual-bot architecture with separate entry points
- **Main Bot** (`bot.js`): Handles waifu collection, spawning, trading, and user management
- **Guess Bot** (`guess_bot.js`): Dedicated bot for character guessing mini-games restricted to an official group
**Rationale**: Separating concerns allows independent scaling and specialized functionality for each bot type

### Polling Configuration

**Problem**: Avoid rate limiting and crashes from Telegram API
**Solution**: Conservative polling strategy
- 3-second intervals between API checks
- 60-second timeout for long-polling
- Auto-start enabled
**Trade-offs**: Slower response times (3s delay) but improved stability and reduced API errors

### Data Persistence Strategy

**Problem**: Need reliable data backup and recovery mechanisms
**Solution**: Multi-layered data persistence
- **Primary Storage**: PostgreSQL database for transactional data
- **JSON Backups**: Automated exports to `data_files/` and `backups/` directories
- **User-specific Files**: Individual JSON files per user in `users/` directory
**Rationale**: Provides redundancy and enables easy data migration or recovery

### Database Schema

**Core Tables**:
- `users`: User profiles with currency balances (berries, gems, crimson), streaks, and preferences
- `waifus`: Character metadata including rarity and attributes
- `harem`: Junction table linking users to collected waifus
- `roles`: User permission system (dev, sudo, uploader)
- `group_settings`: Per-group bot configuration

**Design Pattern**: Relational model with normalized tables and foreign key relationships

### Currency System

**Three-tier economy**:
- **Berries**: Primary currency for basic transactions
- **Gems**: Premium currency (not yet implemented in visible code)
- **Crimson**: Reward currency earned through guess games (100 per correct guess)

### Web Server

**Problem**: Need health monitoring and status visibility
**Solution**: Express.js HTTP server on port 3000
- Serves status page at root endpoint
- Enables Replit keep-alive functionality
**Trade-offs**: Additional resource overhead but necessary for deployment platform requirements

### Environment Configuration

**Problem**: Support multiple deployment environments and token naming conventions
**Solution**: Fallback chain for environment variables
```javascript
// Token resolution with multiple fallbacks
process.env.TELEGRAM_BOT_TOKEN || process.env.BOT_TOKEN || process.env.BOT_TOKEN_1
```
**Required Variables**:
- Bot tokens: `TELEGRAM_BOT_TOKEN`, `BOT_TOKEN`, or `BOT_TOKEN_1` (main), `GUESS_BOT_TOKEN` (guess bot)
- Database: `DATABASE_URL` (PostgreSQL connection string)
- Channels: `CHANNEL_ID`, `UPLOAD_GROUP_ID`
- Admin: `OWNER_ID` or `DEVELOPER_ID`

### Role-Based Access Control

**Three permission tiers**:
1. **Developers** (`dev`): Full system access
2. **Sudos** (`sudo`): Administrative privileges
3. **Uploaders** (`uploader`): Can add new waifus to the system

Stored in `roles` table with junction to `users` table

### Auto-Save System

**Problem**: Prevent data loss from crashes or restarts
**Solution**: Periodic export system (`auto_save_data.js`)
- Exports bot statistics, user data, and waifu collections
- Creates timestamped backups
- Maintains both structured (`data_files/`) and timestamped (`backups/`) copies

## External Dependencies

### Telegram Bot API
- **Library**: `node-telegram-bot-api` v0.66.0
- **Purpose**: Core bot functionality and messaging
- **Integration Points**: Polling-based message handling, inline keyboards, media uploads

### PostgreSQL Database
- **Library**: `pg` v8.16.3 (node-postgres)
- **Purpose**: Primary data storage
- **Schema**: Users, waifus, harem collections, roles, group settings
- **Connection**: Pool-based connection management via `DATABASE_URL`

### Express.js
- **Library**: `express` v4.22.1
- **Purpose**: HTTP server for health checks and status monitoring
- **Endpoints**: Root endpoint (`/`) serves status page

### Environment Management
- **Library**: `dotenv` v16.6.1
- **Purpose**: Secure credential management
- **Usage**: Loads secrets from `.env` file (not committed to repository)

### Node.js Runtime
- **Version**: >=18.0.0
- **Platform**: Replit with nodejs-20 module

### File System
- **Purpose**: JSON backup storage and user data caching
- **Directories**: 
  - `data_files/`: Latest snapshots of bot data, users, waifus
  - `backups/`: Timestamped backup archives
  - `users/`: Individual user JSON files

### Hardcoded Integrations
- **Official Group**: `-1002503593313` (AQUA REALM)
- **Upload Notification Group**: Same as official group
- **Default Owner ID**: `6245574035`